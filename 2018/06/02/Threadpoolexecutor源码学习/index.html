<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="日常学习,源码,Threadpoolexecutor," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="问题 Threadpoolexecutor 各个参数的含义 线程的创建销毁策略 如何实现  使用场景通常使用JDK的executor框架来构建线程池和提交任务 ExecutorService executorService = Executors.newFixedThreadPool(10); executorService.submit(new Callable&amp;lt;String&amp;gt;()">
<meta name="keywords" content="日常学习,源码,Threadpoolexecutor">
<meta property="og:type" content="article">
<meta property="og:title" content="Threadpoolexecutor源码学习">
<meta property="og:url" content="http://blog.kuangenping.com/2018/06/02/Threadpoolexecutor源码学习/index.html">
<meta property="og:site_name" content="noob">
<meta property="og:description" content="问题 Threadpoolexecutor 各个参数的含义 线程的创建销毁策略 如何实现  使用场景通常使用JDK的executor框架来构建线程池和提交任务 ExecutorService executorService = Executors.newFixedThreadPool(10); executorService.submit(new Callable&amp;lt;String&amp;gt;()">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://blog.kuangenping.com/images/threadPoolExecutor.png">
<meta property="og:updated_time" content="2018-07-08T08:50:42.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Threadpoolexecutor源码学习">
<meta name="twitter:description" content="问题 Threadpoolexecutor 各个参数的含义 线程的创建销毁策略 如何实现  使用场景通常使用JDK的executor框架来构建线程池和提交任务 ExecutorService executorService = Executors.newFixedThreadPool(10); executorService.submit(new Callable&amp;lt;String&amp;gt;()">
<meta name="twitter:image" content="http://blog.kuangenping.com/images/threadPoolExecutor.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.kuangenping.com/2018/06/02/Threadpoolexecutor源码学习/"/>





  <title> Threadpoolexecutor源码学习 | noob </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a4a0e3078844e326de08dc016ad5e2bd";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">noob</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">可以叫我菜鸡程序员,但请不要叫我码农</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://blog.kuangenping.com/2018/06/02/Threadpoolexecutor源码学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="sucan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/littledog.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="noob">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Threadpoolexecutor源码学习
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-02T10:54:28+08:00">
                2018-06-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JDK/" itemprop="url" rel="index">
                    <span itemprop="name">JDK</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/06/02/Threadpoolexecutor源码学习/" class="leancloud_visitors" data-flag-title="Threadpoolexecutor源码学习">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ol>
<li>Threadpoolexecutor 各个参数的含义</li>
<li>线程的创建销毁策略</li>
<li>如何实现</li>
</ol>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>通常使用JDK的executor框架来构建线程池和提交任务</p>
<pre><code>ExecutorService executorService = Executors.newFixedThreadPool(10);
executorService.submit(new Callable&lt;String&gt;() {
            @Override
            public String call() throws Exception {
                dosomething();
                return null;
            }
        });
</code></pre><p>在executor框架中，ExecutorService有多个实现类，本文主要介绍的也是我们最常使用的为ThreadPoolExecutor</p>
<h2 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h2><p>构造函数：</p>
<pre><code>public ThreadPoolExecutor(int corePoolSize,
                              int maximumPoolSize,
                              long keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue&lt;Runnable&gt; workQueue,
                              ThreadFactory threadFactory,
                              RejectedExecutionHandler handler) {
        if (corePoolSize &lt; 0 ||
            maximumPoolSize &lt;= 0 ||
            maximumPoolSize &lt; corePoolSize ||
            keepAliveTime &lt; 0)
            throw new IllegalArgumentException();
        if (workQueue == null || threadFactory == null || handler == null)
            throw new NullPointerException();
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.workQueue = workQueue;
        this.keepAliveTime = unit.toNanos(keepAliveTime);
        this.threadFactory = threadFactory;
        this.handler = handler;
    }
</code></pre><ol>
<li>corePoolSize</li>
</ol>
<p>核心线程数,线程池内恒定线程数量</p>
<ol start="2">
<li>maximumPoolSize</li>
</ol>
<p>最大线程数，线程池内运行存在的最大线程数</p>
<ol start="3">
<li>keepAliveTime</li>
</ol>
<p>非核心线程的过期时间</p>
<ol start="4">
<li>unit</li>
</ol>
<p>过期时间的单位</p>
<ol start="5">
<li>workQueue</li>
</ol>
<p>用于存放任务的工作队列</p>
<ol start="6">
<li>threadFactory</li>
</ol>
<p>线程工厂，用于生产线程</p>
<ol start="7">
<li>handler</li>
</ol>
<p>拒绝策略，当线程池中线程达到最大数量时，对新提交的任务的拒绝策略</p>
<h2 id="类结构图"><a href="#类结构图" class="headerlink" title="类结构图"></a>类结构图</h2><p><img src="/images/threadPoolExecutor.png" alt="threadPool"></p>
<p>ThreadPoolExecutor 继承于 AbstractExecutorService，实现了Executor以及ExecutorService接口<br>因此同时包含submit和execute方法，我们先从最核心的execute方法来进行分析</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>execute方法源码如下：</p>
<pre><code>int c = ctl.get();
        if (workerCountOf(c) &lt; corePoolSize) {
            if (addWorker(command, true))
                return;
            c = ctl.get();
        }
        if (isRunning(c) &amp;&amp; workQueue.offer(command)) {
            int recheck = ctl.get();
            if (! isRunning(recheck) &amp;&amp; remove(command))
                reject(command);
            else if (workerCountOf(recheck) == 0)
                addWorker(null, false);
        }
        else if (!addWorker(command, false))
            reject(command);
</code></pre><p>其中比较重要的一个变量是ctl,这是一个AtomicInteger变量，其中高3位表示线程池状态，低29位表示线程数量<br>我们继续看源码，假设我们现在的场景是刚刚初始化了一个线程池，核心线程数为3，最大线程数为5</p>
<p>首先是调用<code>workerCountOf</code>方法来获得当前线程数，我们现在是第一次提交任务，因此当前线程数为0，小于核心线程数3，因此会执行<code>addWorker</code>方法<br>我们继续debug到<code>addWorker</code>方法里，看看都做了些什么操作。</p>
<p><code>addWorker</code>一共做了两个操作，我们先来看看第一部分</p>
<p>step 1:对ctl做cas操作增加线程数</p>
<pre><code>retry:
        for (;;) {
            int c = ctl.get();
            int rs = runStateOf(c);

            // Check if queue empty only if necessary.
            if (rs &gt;= SHUTDOWN &amp;&amp;
                ! (rs == SHUTDOWN &amp;&amp;
                   firstTask == null &amp;&amp;
                   ! workQueue.isEmpty()))
                return false;

            for (;;) {
                int wc = workerCountOf(c);
                if (wc &gt;= CAPACITY ||
                    wc &gt;= (core ? corePoolSize : maximumPoolSize))
                    return false;
                if (compareAndIncrementWorkerCount(c))
                    break retry;
                c = ctl.get();  // Re-read ctl
                if (runStateOf(c) != rs)
                    continue retry;
                // else CAS failed due to workerCount change; retry inner loop
            }
        }
</code></pre><ol>
<li>首先先检查了一下当前线程池的状态，若当前状态不接受新的work则直接返回false</li>
<li>然后就是检查当前线程数是否超过限制，对于核心线程来说是不能超过核心线程数也就是3，对于其他线程来说是不能超过最大线程数，也就是5</li>
<li>然后就是cas操作，增加线程数，若成功，则跳出循环</li>
<li>操作3在并发情况下有可能出现操作失败的场景，若失败则先检查一下当前线程池状态是否发生变化，若变化了则跳到步骤1<br>若状态未发生变化则跳到操作2</li>
</ol>
<p>在成功添加线程数之后就开始真正地添加任务了</p>
<p>step 2 添加worker</p>
<pre><code>boolean workerStarted = false;
boolean workerAdded = false;
Worker w = null;
try {
    final ReentrantLock mainLock = this.mainLock;
    w = new Worker(firstTask);
    final Thread t = w.thread;
    if (t != null) {
        mainLock.lock();
        try {
            // Recheck while holding lock.
            // Back out on ThreadFactory failure or if
            // shut down before lock acquired.
            int c = ctl.get();
            int rs = runStateOf(c);

            if (rs &lt; SHUTDOWN ||
                (rs == SHUTDOWN &amp;&amp; firstTask == null)) {
                if (t.isAlive()) // precheck that t is startable
                    throw new IllegalThreadStateException();
                workers.add(w);
                int s = workers.size();
                if (s &gt; largestPoolSize)
                    largestPoolSize = s;
                workerAdded = true;
            }
        } finally {
            mainLock.unlock();
        }
        if (workerAdded) {
            t.start();
            workerStarted = true;
        }
    }
} finally {
    if (! workerStarted)
        addWorkerFailed(w);
}
</code></pre><p>可以看到首先是将task做为入参<em>new</em>了一个<em>Worker</em>的对象,我们先去看看<em>Worker</em>对象的构造函数</p>
<pre><code>Worker(Runnable firstTask) {
            setState(-1); // inhibit interrupts until runWorker
            this.firstTask = firstTask;
            this.thread = getThreadFactory().newThread(this);
        }
</code></pre><p><em>Worker</em>是<em>ThreadPoolExecutor</em>的一个内部类继承了<em>AbstractQueuedSynchronizer</em>实现了<em>Runnable</em>接口<br>构造函数做的事情就是将aqs的state置为-1，并使用我们提供的线程工厂创建一个线程，然后这里需要注意的一点是这里调用newThread方法传的参数是this，也就是说创建的所有线程实际运行的时候都是执行的<em>Worker</em>类的<br>run方法</p>
<p>接下来就是将<em>Worker</em>对象添加进<em>workers</em>中，在添加前同样会先判断当前线程池的状态是否可以添加线程<br>另外由于<em>workers</em>是一个hashSet，hashSet底层又是调用的hashmap因此是线程不安全的，所以此处还使用了一个全局的<em>ReentrantLock</em>来对添加方法加锁</p>
<p>如果添加线程成功的话，则会启动该线程，若失败的话则会调用<code>addWorkerFailed</code>方法，<code>addWorkerFailed</code>做的事就是把<em>Worker</em>对象从<em>workers</em>中移除，并将当前线程数减1<br>同时调用<code>tryTerminate</code>尝试终止线程池。</p>
<p><code>tryTerminate</code>方法主要做的事情有:</p>
<ol>
<li>若当前线程池的状态不可终止，则不做任何事</li>
<li>若线程池的状态为可以终止状态，但工作队列不为空，则interrupt掉<em>workers</em>中的一个线程</li>
<li>若线程池的状态为可以终止状态且工作队列为空，将当前线程池状态置为TERMINATED</li>
</ol>
<p>前面说到了启动线程其实是调用<em>Worker</em>的<code>run</code>方法，我们去看看<code>run</code>方法里面到底做了什么</p>
<p><code>run</code>调用的是父类中的<code>runWork</code>方法，代码如下</p>
<pre><code>Thread wt = Thread.currentThread();
        Runnable task = w.firstTask;
        w.firstTask = null;
        w.unlock(); // allow interrupts
        boolean completedAbruptly = true;
        try {
            while (task != null || (task = getTask()) != null) {
                w.lock();
                // If pool is stopping, ensure thread is interrupted;
                // if not, ensure thread is not interrupted.  This
                // requires a recheck in second case to deal with
                // shutdownNow race while clearing interrupt
                if ((runStateAtLeast(ctl.get(), STOP) ||
                     (Thread.interrupted() &amp;&amp;
                      runStateAtLeast(ctl.get(), STOP))) &amp;&amp;
                    !wt.isInterrupted())
                    wt.interrupt();
                try {
                    beforeExecute(wt, task);
                    Throwable thrown = null;
                    try {
                        task.run();
                    } catch (RuntimeException x) {
                        thrown = x; throw x;
                    } catch (Error x) {
                        thrown = x; throw x;
                    } catch (Throwable x) {
                        thrown = x; throw new Error(x);
                    } finally {
                        afterExecute(task, thrown);
                    }
                } finally {
                    task = null;
                    w.completedTasks++;
                    w.unlock();
                }
            }
            completedAbruptly = false;
        } finally {
            processWorkerExit(w, completedAbruptly);
        }
</code></pre><p>去掉一些不重要的逻辑我们可以看到<code>runWork</code>方法就是用当前线程不停地去取task，然后调用task的run方法<br>task可以是一开始创建这个work时初始化的，也可以是调用<code>getTask</code>方法获取到的</p>
<p><code>getTask</code>方法如下：</p>
<pre><code>boolean timedOut = false; // Did the last poll() time out?

        retry:
        for (;;) {
            int c = ctl.get();
            int rs = runStateOf(c);

            // Check if queue empty only if necessary.
            if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) {
                decrementWorkerCount();
                return null;
            }

            boolean timed;      // Are workers subject to culling?

            for (;;) {
                int wc = workerCountOf(c);
                timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;

                if (wc &lt;= maximumPoolSize &amp;&amp; ! (timedOut &amp;&amp; timed))
                    break;
                if (compareAndDecrementWorkerCount(c))
                    return null;
                c = ctl.get();  // Re-read ctl
                if (runStateOf(c) != rs)
                    continue retry;
                // else CAS failed due to workerCount change; retry inner loop
            }

            try {
                Runnable r = timed ?
                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
                    workQueue.take();
                if (r != null)
                    return r;
                timedOut = true;
            } catch (InterruptedException retry) {
                timedOut = false;
            }
        }
</code></pre><p>这个方法做的事就是从一个阻塞队列中获取值，其中比较重要的一些状态的判断逻辑</p>
<ol>
<li>当前线程池状态为SHUTDOWN并且workqueue为空，或者当前线程池状态为STOP时直接返回null</li>
<li>若当前线程数大于了最大线程数，减少一个线程数，并返回null</li>
<li>如若当前线程数大于核心线程数或者设置了允许核心线程数过期，同时从workqueue队列中取数据超时，返回null，减少一个线程数</li>
</ol>
<p>至此，当当前线程数小于核心线程数时的全部流程我们走过一遍了，接下来我们再回到一开始的<code>execute</code>方法，看看当前线程数大于核心线程数时的策略</p>
<pre><code>if (isRunning(c) &amp;&amp; workQueue.offer(command)) {
            int recheck = ctl.get();
            if (! isRunning(recheck) &amp;&amp; remove(command))
                reject(command);
            else if (workerCountOf(recheck) == 0)
                addWorker(null, false);
        }
        else if (!addWorker(command, false))
            reject(command);
</code></pre><ol>
<li>若当前线程池的状态为RUNNING并且，向workQueue中添加任务成功，则进行recheck操作</li>
<li>recheck操作主要是防止添加任务之后线程池状态变更，以及在设置了过期时间之后，当前线程全部过期的场景</li>
<li>如果添加任务失败，或者出现线程池状态变更，则进行reject操作</li>
</ol>
<p>reject操作实际上就是调用我们自定义的或者默认的<code>RejectedExecutionHandler</code></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面我们已经把线程池的核心代码全部梳理了一遍，下面我们就来把这些零散的东西总结一下</p>
<h3 id="线程池的几种状态"><a href="#线程池的几种状态" class="headerlink" title="线程池的几种状态"></a>线程池的几种状态</h3><p>线程池一共有5种状态，分别为Running、ShutDown、Stop、Tidying、Terminated</p>
<ol>
<li>Running</li>
</ol>
<p>当线程池初始化完成之后就为Running状态，此状态可以正常地接收任务并处理任务</p>
<ol start="2">
<li>ShutDown</li>
</ol>
<p>当主动调用了<code>shutdown</code>方法之后，若当前状态为Running，则会将状态修改为ShutDown<br>并且<code>shutdown</code>方法会调用</p>
<pre><code>interruptIdleWorkers(false);
</code></pre><p>此方法的作用是调用当前所有线程的<code>interrupt</code>方法，将当前所有线程标记为中断状态<br>然后又<code>addWork</code>可知，一旦当前状态不是Running的时候，是不会添加新的任务的，<br>因此，ShutDown状态的线程池的状态是：不接受新任务添加，但会处理已有任务</p>
<ol start="3">
<li>Stop</li>
</ol>
<p>当主动调用<code>shutdownNow</code>方法后，若当前状态为Running，或者ShutDown，则将当前状态置为Stop<br>此状态与ShutDown的区别在于，<code>shutdownNow</code>方法会移除掉当前workQueue中的所有任务。<br>因此当前状态的线程池的状态是：不接受新任务添加，且不执行未执行的任务</p>
<ol start="4">
<li>Tidying</li>
</ol>
<p>当当前线程池中线程数为0，并且workQueue为空时，当前线程池状态为Tidying</p>
<ol start="5">
<li>Terminated</li>
</ol>
<p>当执行完<code>terminated</code>方法后，线程池的状态会被置为Terminated</p>
<h3 id="线程池的添加策略"><a href="#线程池的添加策略" class="headerlink" title="线程池的添加策略"></a>线程池的添加策略</h3><ol>
<li>若当前线程数小于核心线程数则添加一个<em>Work</em>也就是一个线程</li>
<li>若当前线程数大于等于核心线程数则向<em>workQueue</em>也就是参数中的工作队列中添加一个task</li>
<li>若当前线程数大于等于核心线程数并且<em>workQueue</em>队列已满，则添加一个非核心线程</li>
<li>若当前线程数大于等于最大线程数，则使用定义好的拒绝策略拒绝掉此次任务</li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/日常学习/" rel="tag"># 日常学习</a>
          
            <a href="/tags/源码/" rel="tag"># 源码</a>
          
            <a href="/tags/Threadpoolexecutor/" rel="tag"># Threadpoolexecutor</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/02/reentrantlock源码学习/" rel="next" title="reentrantlock源码学习">
                <i class="fa fa-chevron-left"></i> reentrantlock源码学习
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/06/02/hashmap/" rel="prev" title="hashmap">
                hashmap <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/littledog.jpg"
               alt="sucan" />
          <p class="site-author-name" itemprop="name">sucan</p>
           
              <p class="site-description motion-element" itemprop="description">可以叫我菜鸡程序员,但请不要叫我码农</p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.heshengbang.tech" title="fufu" target="_blank">fufu</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#问题"><span class="nav-number">1.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用场景"><span class="nav-number">2.</span> <span class="nav-text">使用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参数说明"><span class="nav-number">3.</span> <span class="nav-text">参数说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#类结构图"><span class="nav-number">4.</span> <span class="nav-text">类结构图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码分析"><span class="nav-number">5.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#线程池的几种状态"><span class="nav-number">6.1.</span> <span class="nav-text">线程池的几种状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程池的添加策略"><span class="nav-number">6.2.</span> <span class="nav-text">线程池的添加策略</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sucan</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  





  



  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("ImkSh1jOKQgp4jyiXL0oUxkz-gzGzoHsz", "1BLaPwDOrMXid2kOtKUxdDID");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


  

</body>
</html>
